{"ast":null,"code":"import _regeneratorRuntime from\"/home/brian/Desktop/non-functional-wa-connection-demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/brian/Desktop/non-functional-wa-connection-demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/home/brian/Desktop/non-functional-wa-connection-demo/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{jsxs as _jsxs}from\"react/jsx-runtime\";import{jsx as _jsx}from\"react/jsx-runtime\";import React,{useState,useEffect,Fragment}from\"react\";import TextEditor from\"./../components/TextEditor/TextEditor\";import MediaGadget from\"./../components/MediaGadget/MediaGadget\";import AddTextEditor from\"./../components/AddTextEditor/AddTextEditor\";import{CreateVariant,EditVariant,DeleteVariant,DeleteAll,SetActiveVariant}from\"./../store/actions/MediaMessageVariantAction\";import{changeNav as _changeNav}from\"./../store/actions/SideNavActions\";import{Loading,Table,TableRow,TableHead,TableHeader,TableCell,Button,Modal,InlineLoading,ExpandableTile,TileAboveTheFoldContent,TableBody}from\"carbon-components-react\";import{useHistory}from\"react-router-dom\";import{connect}from\"react-redux\";import{useFirestoreConnect,useFirebase}from\"react-redux-firebase\";import{Send16}from\"@carbon/icons-react\";import SelectConnection from\"./../components/SelectConnection/SelectConnection\";function SendMediaMessage(props){useEffect(function(){props.deleteAll();},[]);var firebase=useFirebase();var database=firebase.database();var history=useHistory();var _useState=useState(\"\"),_useState2=_slicedToArray(_useState,2),selectedConnection=_useState2[0],setSelectedConnection=_useState2[1];var _useState3=useState(\"\"),_useState4=_slicedToArray(_useState3,2),selectedContact=_useState4[0],setSelectedContact=_useState4[1];var _useState5=useState(\"10\"),_useState6=_slicedToArray(_useState5,2),selectedCooldown=_useState6[0],setSelectedCooldown=_useState6[1];var _useState7=useState([]),_useState8=_slicedToArray(_useState7,2),contactsInterval=_useState8[0],setContactsInterval=_useState8[1];var _useState9=useState(\"\"),_useState10=_slicedToArray(_useState9,2),text=_useState10[0],setText=_useState10[1];var _useState11=useState(false),_useState12=_slicedToArray(_useState11,2),loading=_useState12[0],setLoading=_useState12[1];var _useState13=useState([]),_useState14=_slicedToArray(_useState13,2),sendStatus=_useState14[0],setSendStaus=_useState14[1];var _useState15=useState(false),_useState16=_slicedToArray(_useState15,2),dispatchStatus=_useState16[0],setDispatchStatus=_useState16[1];var _useState17=useState(false),_useState18=_slicedToArray(_useState17,2),sendMessasges=_useState18[0],setSendMessages=_useState18[1];var _useState19=useState(false),_useState20=_slicedToArray(_useState19,2),addText=_useState20[0],setAddText=_useState20[1];var _useState21=useState({id:\"contact\",variables:[\"Contact list is not selected\"],length:1}),_useState22=_slicedToArray(_useState21,2),contact=_useState22[0],setContact=_useState22[1];useEffect(function(){console.log(contactsInterval);},[contactsInterval]);var calcContactsInterval=function calcContactsInterval(){var messageAmount=Math.floor(290/(5+parseInt(selectedCooldown)));console.log(\"Message amount: \",messageAmount);console.log(\"Contact length: \",contact.length);var messageQuant=messageAmount>contact.length?1:Math.floor(contact.length/messageAmount);var messageReminder=messageAmount>contact.length?0:Math.floor(contact.length%messageAmount);var tmpInterval=[];var lastSuperior=0;for(var i=0;i<messageQuant;i++){if(messageAmount>contact.length){tmpInterval.push([0,contact.length]);}else{tmpInterval.push([i*messageAmount,(i+1)*messageAmount]);}lastSuperior=(i+1)*messageAmount;}if(messageReminder!==0){tmpInterval.push([lastSuperior,lastSuperior+messageReminder]);}setContactsInterval(tmpInterval);console.log(\"tmpInterval: \",tmpInterval);};useEffect(function(){calcContactsInterval();},[contact,selectedCooldown,selectedConnection]);var handleSelectCooldown=function handleSelectCooldown(e){setSelectedCooldown(e.target.value);};var db=function db(){database.ref(\"user/\".concat(props.uid,\"/mediaMessage\")).remove();database.ref(\"user/\".concat(props.uid,\"/mediaMessage\")).on(\"value\",function(data){if(data.exists()){var res=data.val();setSendStaus(res);setLoading(false);toggleDispatch();props.deleteAll();}});};var deleteDB=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setSendStaus([]);_context.next=3;return database.ref(\"user/\".concat(props.uid,\"/mediaMessage\")).remove();case 3:case\"end\":return _context.stop();}}},_callee);}));return function deleteDB(){return _ref.apply(this,arguments);};}();var handleSelectConnection=function handleSelectConnection(e){setSelectedConnection(e.target.value);};var toggleDispatch=function toggleDispatch(){setDispatchStatus(!dispatchStatus);};var handleModalClose=function handleModalClose(){deleteDB();props.changeNav(\"dashboard\");history.push(\"/app/dashboard\");};var handleSelectContact=function handleSelectContact(e){var tmpContact=props.contacts.find(function(elm){return elm.id===e.target.value;});setSelectedContact(e.target.value);setContact(tmpContact);};var sendMessages=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var fireWall,i,tmpToken;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:setLoading(true);db();fireWall=false;i=0;case 4:if(!(i<contactsInterval.length)){_context2.next=14;break;}if(fireWall){_context2.next=11;break;}_context2.next=8;return firebase.auth().currentUser.getIdToken(true);case 8:tmpToken=_context2.sent;_context2.next=11;return fetch(\"https://us-central1-connectivitys-2066c.cloudfunctions.net/api/sendSingleMediaMessage/\",{method:\"POST\",body:JSON.stringify({uid:props.uid,contactId:selectedContact,connectionId:selectedConnection,variants:props.mediaMessageVariants,token:tmpToken,cooldown:selectedCooldown*1000,contactsInterval:contactsInterval[i],isFirst:i===0,isLast:i===contactsInterval.length-1}),headers:{\"Content-Type\":\"application/json\"}}).then(function(res){return res.json();}).catch(function(err){fireWall=true;console.log(\"Error response from server: \",err);});case 11:i++;_context2.next=4;break;case 14:case\"end\":return _context2.stop();}}},_callee2);}));return function sendMessages(){return _ref2.apply(this,arguments);};}();useFirestoreConnect([{collection:\"user\",doc:props.uid,subcollections:[{collection:\"contacts\"}],storeAs:\"contacts\"},{collection:\"user\",doc:props.uid,subcollections:[{collection:\"credentials\"}],storeAs:\"connections\"}]);if(dispatchStatus){return/*#__PURE__*/_jsx(Modal,{open:dispatchStatus,passiveModal:true,onRequestClose:handleModalClose,modalHeading:\"Dispatch status\",hasForm:true,children:/*#__PURE__*/_jsxs(Table,{children:[/*#__PURE__*/_jsx(TableHead,{children:/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsx(TableHeader,{}),/*#__PURE__*/_jsx(TableHeader,{children:\"Phone \"}),/*#__PURE__*/_jsx(TableHeader,{children:\"Message \"})]})}),/*#__PURE__*/_jsx(TableBody,{children:sendStatus.map(function(elm,i){return/*#__PURE__*/_jsxs(TableRow,{children:[/*#__PURE__*/_jsxs(TableCell,{children:[i,\" \"]}),/*#__PURE__*/_jsx(TableCell,{children:/*#__PURE__*/_jsx(InlineLoading,{status:elm.sendStatus,description:elm.receiverNumber})}),/*#__PURE__*/_jsx(TableCell,{children:/*#__PURE__*/_jsxs(ExpandableTile,{children:[/*#__PURE__*/_jsx(\"p\",{}),/*#__PURE__*/_jsx(TileAboveTheFoldContent,{children:/*#__PURE__*/_jsx(\"p\",{children:elm.message})})]})})]},i);})})]})});}else{return/*#__PURE__*/_jsxs(\"div\",{className:\"send-text-message\",children:[loading?/*#__PURE__*/_jsx(Loading,{}):null,/*#__PURE__*/_jsx(SelectConnection,{handleSelectContact:handleSelectContact,handleSelectConnection:handleSelectConnection,handleSelectCooldown:handleSelectCooldown,cooldown:selectedCooldown}),/*#__PURE__*/_jsx(MediaGadget,{setAddText:setAddText,setSendMessage:setSendMessages}),sendMessasges?/*#__PURE__*/_jsxs(Fragment,{children:[props.mediaMessageVariants.variants.map(function(elm,i){return/*#__PURE__*/_jsx(\"div\",{onClick:function onClick(){return props.setActiveVariant(i);},children:/*#__PURE__*/_jsx(TextEditor,{editVariant:props.editVariant,variables:contact.variables,editorIndex:i,textState:elm.textState,open:elm.active},i)});}),addText?/*#__PURE__*/_jsx(AddTextEditor,{messageType:\"media\"}):null,/*#__PURE__*/_jsx(Button,{kind:\"primary\",style:{marginTop:\"64px\"},renderIcon:Send16,onClick:sendMessages,children:\"Send Messages\"})]}):null]});}}var stateToProps=function stateToProps(state){return{mediaMessageVariants:state.mediaMessageVariants,contacts:state.firestore.ordered.contacts,connections:state.firestore.ordered.connections,uid:state.firebase.auth.uid,token:state.firebase.profile.token.token};};var dispatchToProps=function dispatchToProps(dispatch){return{changeNav:function changeNav(elm){return dispatch(_changeNav(elm));},createVariant:function createVariant(elm){return dispatch(CreateVariant(elm));},deleteVariant:function deleteVariant(id){return dispatch(DeleteVariant(id));},editVariant:function editVariant(index,text){return dispatch(EditVariant(index,text));},deleteAll:function deleteAll(){return dispatch(DeleteAll());},setActiveVariant:function setActiveVariant(id){return dispatch(SetActiveVariant(id));}};};export default connect(stateToProps,dispatchToProps)(SendMediaMessage);","map":{"version":3,"sources":["/home/brian/Desktop/non-functional-wa-connection-demo/src/pages/SendMediaMessage.js"],"names":["React","useState","useEffect","Fragment","TextEditor","MediaGadget","AddTextEditor","CreateVariant","EditVariant","DeleteVariant","DeleteAll","SetActiveVariant","changeNav","Loading","Table","TableRow","TableHead","TableHeader","TableCell","Button","Modal","InlineLoading","ExpandableTile","TileAboveTheFoldContent","TableBody","useHistory","connect","useFirestoreConnect","useFirebase","Send16","SelectConnection","SendMediaMessage","props","deleteAll","firebase","database","history","selectedConnection","setSelectedConnection","selectedContact","setSelectedContact","selectedCooldown","setSelectedCooldown","contactsInterval","setContactsInterval","text","setText","loading","setLoading","sendStatus","setSendStaus","dispatchStatus","setDispatchStatus","sendMessasges","setSendMessages","addText","setAddText","id","variables","length","contact","setContact","console","log","calcContactsInterval","messageAmount","Math","floor","parseInt","messageQuant","messageReminder","tmpInterval","lastSuperior","i","push","handleSelectCooldown","e","target","value","db","ref","uid","remove","on","data","exists","res","val","toggleDispatch","deleteDB","handleSelectConnection","handleModalClose","handleSelectContact","tmpContact","contacts","find","elm","sendMessages","fireWall","auth","currentUser","getIdToken","tmpToken","fetch","method","body","JSON","stringify","contactId","connectionId","variants","mediaMessageVariants","token","cooldown","isFirst","isLast","headers","then","json","catch","err","collection","doc","subcollections","storeAs","map","receiverNumber","message","setActiveVariant","editVariant","textState","active","marginTop","stateToProps","state","firestore","ordered","connections","profile","dispatchToProps","dispatch","createVariant","deleteVariant","index"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, Fragment } from \"react\";\nimport TextEditor from \"./../components/TextEditor/TextEditor\";\nimport MediaGadget from \"./../components/MediaGadget/MediaGadget\";\nimport AddTextEditor from \"./../components/AddTextEditor/AddTextEditor\";\nimport {\n  CreateVariant,\n  EditVariant,\n  DeleteVariant,\n  DeleteAll,\n  SetActiveVariant,\n} from \"./../store/actions/MediaMessageVariantAction\";\nimport { changeNav } from \"./../store/actions/SideNavActions\";\nimport {\n  Loading,\n  Table,\n  TableRow,\n  TableHead,\n  TableHeader,\n  TableCell,\n  Button,\n  Modal,\n  InlineLoading,\n  ExpandableTile,\n  TileAboveTheFoldContent,\n  TableBody,\n} from \"carbon-components-react\";\n\nimport { useHistory } from \"react-router-dom\";\nimport { connect } from \"react-redux\";\nimport { useFirestoreConnect, useFirebase } from \"react-redux-firebase\";\nimport { Send16 } from \"@carbon/icons-react\";\nimport SelectConnection from \"./../components/SelectConnection/SelectConnection\";\n\nfunction SendMediaMessage(props) {\n  useEffect(() => {\n    props.deleteAll();\n  }, []);\n  const firebase = useFirebase();\n  const database = firebase.database();\n  const history = useHistory();\n  const [selectedConnection, setSelectedConnection] = useState(\"\");\n  const [selectedContact, setSelectedContact] = useState(\"\");\n  const [selectedCooldown, setSelectedCooldown] = useState(\"10\");\n  const [contactsInterval, setContactsInterval] = useState([]);\n\n  const [text, setText] = useState(\"\");\n  const [loading, setLoading] = useState(false);\n  const [sendStatus, setSendStaus] = useState([]);\n  const [dispatchStatus, setDispatchStatus] = useState(false);\n  const [sendMessasges, setSendMessages] = useState(false);\n  const [addText, setAddText] = useState(false);\n\n  const [contact, setContact] = useState({\n    id: \"contact\",\n    variables: [\"Contact list is not selected\"],\n    length: 1,\n  });\n\n  useEffect(() => {\n    console.log(contactsInterval);\n  }, [contactsInterval]);\n\n  const calcContactsInterval = () => {\n    const messageAmount = Math.floor(290 / (5 + parseInt(selectedCooldown)));\n    console.log(\"Message amount: \", messageAmount);\n    console.log(\"Contact length: \", contact.length);\n\n    const messageQuant =\n      messageAmount > contact.length\n        ? 1\n        : Math.floor(contact.length / messageAmount);\n    const messageReminder =\n      messageAmount > contact.length\n        ? 0\n        : Math.floor(contact.length % messageAmount);\n    let tmpInterval = [];\n    let lastSuperior = 0;\n\n    for (let i = 0; i < messageQuant; i++) {\n      if (messageAmount > contact.length) {\n        tmpInterval.push([0, contact.length]);\n      } else {\n        tmpInterval.push([i * messageAmount, (i + 1) * messageAmount]);\n      }\n      lastSuperior = (i + 1) * messageAmount;\n    }\n    if (messageReminder !== 0) {\n      tmpInterval.push([lastSuperior, lastSuperior + messageReminder]);\n    }\n    setContactsInterval(tmpInterval);\n    console.log(\"tmpInterval: \", tmpInterval);\n  };\n\n  useEffect(() => {\n    calcContactsInterval();\n  }, [contact, selectedCooldown, selectedConnection]);\n\n  const handleSelectCooldown = (e) => {\n    setSelectedCooldown(e.target.value);\n  };\n\n  const db = () => {\n    database.ref(`user/${props.uid}/mediaMessage`).remove();\n    database.ref(`user/${props.uid}/mediaMessage`).on(\"value\", (data) => {\n      if (data.exists()) {\n        const res = data.val();\n        setSendStaus(res);\n        setLoading(false);\n        toggleDispatch();\n        props.deleteAll();\n      }\n    });\n  };\n\n  const deleteDB = async () => {\n    setSendStaus([]);\n    await database.ref(`user/${props.uid}/mediaMessage`).remove();\n  };\n\n  const handleSelectConnection = (e) => {\n    setSelectedConnection(e.target.value);\n  };\n\n  const toggleDispatch = () => {\n    setDispatchStatus(!dispatchStatus);\n  };\n\n  const handleModalClose = () => {\n    deleteDB();\n    props.changeNav(\"dashboard\");\n    history.push(\"/app/dashboard\");\n  };\n\n  const handleSelectContact = (e) => {\n    const tmpContact = props.contacts.find((elm) => {\n      return elm.id === e.target.value;\n    });\n    setSelectedContact(e.target.value);\n    setContact(tmpContact);\n  };\n\n  const sendMessages = async () => {\n    setLoading(true);\n    db();\n\n    let fireWall = false;\n\n    for (let i = 0; i < contactsInterval.length; i++) {\n      if (!fireWall) {\n        const tmpToken = await firebase.auth().currentUser.getIdToken(true);\n        await fetch(\n          \"https://us-central1-connectivitys-2066c.cloudfunctions.net/api/sendSingleMediaMessage/\",\n          {\n            method: \"POST\",\n            body: JSON.stringify({\n              uid: props.uid,\n              contactId: selectedContact,\n              connectionId: selectedConnection,\n              variants: props.mediaMessageVariants,\n              token: tmpToken,\n              cooldown: selectedCooldown * 1000,\n              contactsInterval: contactsInterval[i],\n              isFirst: i === 0,\n              isLast: i === contactsInterval.length - 1,\n            }),\n            headers: {\n              \"Content-Type\": \"application/json\",\n            },\n          }\n        )\n          .then((res) => {\n            return res.json();\n          })\n          .catch((err) => {\n            fireWall = true;\n            console.log(\"Error response from server: \", err);\n          });\n      }\n    }\n  };\n\n  useFirestoreConnect([\n    {\n      collection: \"user\",\n      doc: props.uid,\n      subcollections: [{ collection: \"contacts\" }],\n      storeAs: \"contacts\",\n    },\n    {\n      collection: \"user\",\n      doc: props.uid,\n      subcollections: [{ collection: \"credentials\" }],\n      storeAs: \"connections\",\n    },\n  ]);\n\n  if (dispatchStatus) {\n    return (\n      <Modal\n        open={dispatchStatus}\n        passiveModal\n        onRequestClose={handleModalClose}\n        modalHeading=\"Dispatch status\"\n        hasForm\n      >\n        <Table>\n          <TableHead>\n            <TableRow>\n              <TableHeader />\n              <TableHeader>Phone </TableHeader>\n              <TableHeader>Message </TableHeader>\n            </TableRow>\n          </TableHead>\n          <TableBody>\n            {sendStatus.map((elm, i) => {\n              return (\n                <TableRow key={i}>\n                  <TableCell>{i} </TableCell>\n                  <TableCell>\n                    <InlineLoading\n                      status={elm.sendStatus}\n                      description={elm.receiverNumber}\n                    />\n                  </TableCell>\n                  <TableCell>\n                    <ExpandableTile>\n                      <p></p>\n                      <TileAboveTheFoldContent>\n                        <p>{elm.message}</p>\n                      </TileAboveTheFoldContent>\n                    </ExpandableTile>\n                  </TableCell>\n                </TableRow>\n              );\n            })}\n          </TableBody>\n        </Table>\n      </Modal>\n    );\n  } else {\n    return (\n      <div className=\"send-text-message\">\n        {loading ? <Loading /> : null}\n        <SelectConnection\n          handleSelectContact={handleSelectContact}\n          handleSelectConnection={handleSelectConnection}\n          handleSelectCooldown={handleSelectCooldown}\n          cooldown={selectedCooldown}\n        />\n\n        <MediaGadget setAddText={setAddText} setSendMessage={setSendMessages} />\n\n        {sendMessasges ? (\n          <Fragment>\n            {props.mediaMessageVariants.variants.map((elm, i) => {\n              return (\n                <div onClick={() => props.setActiveVariant(i)}>\n                  <TextEditor\n                    key={i}\n                    editVariant={props.editVariant}\n                    variables={contact.variables}\n                    editorIndex={i}\n                    textState={elm.textState}\n                    open={elm.active}\n                  />\n                </div>\n              );\n            })}\n\n            {addText ? <AddTextEditor messageType=\"media\" /> : null}\n\n            <Button\n              kind=\"primary\"\n              style={{ marginTop: \"64px\" }}\n              renderIcon={Send16}\n              onClick={sendMessages}\n            >\n              Send Messages\n            </Button>\n          </Fragment>\n        ) : null}\n      </div>\n    );\n  }\n}\n\nconst stateToProps = (state) => {\n  return {\n    mediaMessageVariants: state.mediaMessageVariants,\n    contacts: state.firestore.ordered.contacts,\n    connections: state.firestore.ordered.connections,\n    uid: state.firebase.auth.uid,\n    token: state.firebase.profile.token.token,\n  };\n};\n\nconst dispatchToProps = (dispatch) => {\n  return {\n    changeNav: (elm) => dispatch(changeNav(elm)),\n    createVariant: (elm) => dispatch(CreateVariant(elm)),\n    deleteVariant: (id) => dispatch(DeleteVariant(id)),\n    editVariant: (index, text) => dispatch(EditVariant(index, text)),\n    deleteAll: () => dispatch(DeleteAll()),\n    setActiveVariant: (id) => dispatch(SetActiveVariant(id)),\n  };\n};\n\nexport default connect(stateToProps, dispatchToProps)(SendMediaMessage);\n"]},"metadata":{},"sourceType":"module"}